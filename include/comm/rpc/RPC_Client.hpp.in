/*
  File: RPC_Client.hpp
  Date: May, 2018
  Author: Dagim Sisay <dagiopia@gmail.com>
  License: AGPL
*/

#ifndef _RPC_CLIENT_HPP_
#define _RPC_CLIENT_HPP_

#include <iostream>
#include <string>
#include <vector>

#include <grpcpp/grpcpp.h>

//#include <opencv2/opencv.hpp>
#include "sense/vision/VisionCommon.hpp"
#include "util/base64.h"

#include "EmotionService.grpc.pb.h"

#define SERVER_ADDRESS "@SERVER_ADDRESS@"
#define IMG_ENCODING ".jpg"

using grpc::Status;
using grpc::Channel;
using grpc::CreateChannel;
using grpc::ClientContext;


class RPC_Client
{    
    public:
      RPC_Client() : stub_(EmotionRecognition::NewStub(grpc::CreateChannel(
      				SERVER_ADDRESS, grpc::InsecureChannelCredentials()))) {}
      ~RPC_Client() {}

      bool detect_emotion(cv::Mat &in, std::vector<std::string> &out_emos, std::vector<cv::Rect> &out_boxes);

    private:
      std::unique_ptr<EmotionRecognition::Stub> stub_;

      std::vector<unsigned char> vbuff;
      unsigned char *ucbuff;
      cv::Rect rct;

      void encode_img(cv::Mat);
      std::string encode_img_b64(cv::Mat);
};


#endif //_RPC_CLIENT_HPP_
